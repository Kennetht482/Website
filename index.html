<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media Gallery</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="site-header">
    <h1>Images/Audio</h1>
  </header>

  <main>
    <section id="gallery" class="gallery" aria-live="polite"></section>

    <template id="image-card-template">
      <figure class="card">
        <img alt="" loading="lazy">
        <figcaption>
          <strong class="title"></strong>
          <p class="caption"></p>
        </figcaption>
      </figure>
    </template>

    <template id="audio-card-template">
      <figure class="card audio-card">
        <div class="audio-media">
          <audio controls preload="none"></audio>
        </div>
        <figcaption>
          <strong class="title"></strong>
          <p class="caption"></p>
          <p class="audio-meta"><a class="download-link" target="_blank" rel="noopener">Download</a></p>
        </figcaption>
      </figure>
    </template>
  </main>

  <script>
    async function loadMedia() {
      try {
        const res = await fetch('images.json', {cache: 'no-store'});
        if (!res.ok) throw new Error('images.json not found or network error');
        const items = await res.json();
        const gallery = document.getElementById('gallery');
        const imgTpl = document.getElementById('image-card-template');
        const audioTpl = document.getElementById('audio-card-template');

        if (!Array.isArray(items) || items.length === 0) {
          gallery.innerHTML = '<p class="empty">No media yet. See README to add images or audio.</p>';
          return;
        }

        gallery.innerHTML = '';
        for (const it of items) {
          // default type to image for backward compatibility
          const type = (it.type || 'image').toLowerCase();

          if (type === 'audio') {
            const node = audioTpl.content.cloneNode(true);
            const audioEl = node.querySelector('audio');
            const titleEl = node.querySelector('.title');
            const captionEl = node.querySelector('.caption');
            const downloadLink = node.querySelector('.download-link');

            audioEl.src = it.file;
            audioEl.setAttribute('aria-label', it.title || it.caption || 'Audio');
            audioEl.title = it.title || '';
            // set track or transcript link if provided (optional)
            if (it.transcript) {
              const tlink = document.createElement('a');
              tlink.href = it.transcript;
              tlink.textContent = 'Transcript';
              tlink.target = '_blank';
              tlink.rel = 'noopener';
              captionEl.appendChild(document.createElement('br'));
              captionEl.appendChild(tlink);
            }

            titleEl.textContent = it.title || '';
            captionEl.appendChild(document.createTextNode(it.caption || ''));

            downloadLink.href = it.file;
            downloadLink.textContent = 'Download';

            gallery.appendChild(node);
          } else {
            // treat anything else as image
            const node = imgTpl.content.cloneNode(true);
            const imgEl = node.querySelector('img');
            const titleEl = node.querySelector('.title');
            const captionEl = node.querySelector('.caption');

            imgEl.src = it.file;
            imgEl.alt = it.alt || it.title || '';
            titleEl.textContent = it.title || '';
            captionEl.textContent = it.caption || '';

            gallery.appendChild(node);
          }
        }
      } catch (err) {
        document.getElementById('gallery').innerHTML = '<p class="error">Error loading gallery: ' + err.message + '</p>';
        console.error(err);
      }
    }

    loadMedia();
  </script>
</body>
</html>
