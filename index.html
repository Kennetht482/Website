<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Media Gallery (fixed)</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="site-header">
    <h1>My Media Gallery</h1>
    <p class="subtitle">Add images or audio to the /images/ folder and register them in images.json</p>
    <nav><a href="README.html">How to add media</a></nav>
  </header>

  <main>
    <section id="gallery" class="gallery" aria-live="polite"></section>

    <template id="image-card-template">
      <figure class="card">
        <img alt="" loading="lazy">
        <figcaption>
          <strong class="title"></strong>
          <p class="caption"></p>
        </figcaption>
      </figure>
    </template>

    <template id="audio-card-template">
      <figure class="card audio-card">
        <div class="audio-media">
          <audio controls preload="none">
            <source src="" type="">
            Your browser does not support the audio element.
          </audio>
        </div>
        <figcaption>
          <strong class="title"></strong>
          <p class="caption"></p>
          <p class="audio-meta"><a class="download-link" target="_blank" rel="noopener">Download</a></p>
        </figcaption>
      </figure>
    </template>
  </main>

  <footer class="site-footer">
    <p>Hosted on GitHub Pages â€¢ Edit media by uploading to /images/ and updating images.json</p>
  </footer>

  <script>
    // Wait for DOM to be ready so elements exist even if the script is moved into head.
    document.addEventListener('DOMContentLoaded', () => {
      loadMedia();
    });

    async function loadMedia() {
      const gallery = document.getElementById('gallery');
      const imgTpl = document.getElementById('image-card-template');
      const audioTpl = document.getElementById('audio-card-template');

      if (!gallery) {
        console.error('Gallery element with id="gallery" not found. Make sure your HTML contains <section id="gallery">');
        // Show error to the user
        const body = document.querySelector('body');
        if (body) {
          const el = document.createElement('div');
          el.className = 'error';
          el.textContent = 'Gallery element not found in HTML (see console).';
          body.appendChild(el);
        }
        return;
      }

      if (!imgTpl || !audioTpl) {
        console.error('One or more templates are missing. Expected template IDs: image-card-template, audio-card-template.');
        gallery.innerHTML = '<p class="error">Gallery templates missing. Check console for details.</p>';
        return;
      }

      try {
        const res = await fetch('images.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('images.json not found or network error: ' + res.status + ' ' + res.statusText);
        const items = await res.json();

        if (!Array.isArray(items) || items.length === 0) {
          gallery.innerHTML = '<p class="empty">No media yet. See README to add images or audio.</p>';
          return;
        }

        gallery.innerHTML = '';
        for (const it of items) {
          try {
            // Defensive defaults
            const type = (it && (it.type || 'image')).toLowerCase();

            if (type === 'audio') {
              const node = audioTpl.content.cloneNode(true);
              const audioEl = node.querySelector('audio');
              const sourceEl = audioEl ? audioEl.querySelector('source') : null;
              const titleEl = node.querySelector('.title');
              const captionEl = node.querySelector('.caption');
              const downloadLink = node.querySelector('.download-link');

              if (!audioEl || !sourceEl) {
                console.warn('Audio template missing expected audio/source element for item:', it);
                continue; // skip this item
              }

              // set the file URL and mime/type if provided
              sourceEl.src = it.file || '';
              sourceEl.type = it.mime || 'audio/mp4; codecs="mp4a.40.2"';

              // force reload of the audio element so the new source is picked up
              audioEl.load();

              audioEl.setAttribute('aria-label', it.title || it.caption || 'Audio');

              if (titleEl) titleEl.textContent = it.title || '';
              if (captionEl) {
                // clear then set text content to avoid accidental appends
                captionEl.textContent = it.caption || '';
                if (it.transcript) {
                  const tlink = document.createElement('a');
                  tlink.href = it.transcript;
                  tlink.textContent = 'Transcript';
                  tlink.target = '_blank';
                  tlink.rel = 'noopener';
                  captionEl.appendChild(document.createElement('br'));
                  captionEl.appendChild(tlink);
                }
              }

              if (downloadLink) {
                downloadLink.href = it.file || '#';
                downloadLink.textContent = 'Download';
              }

              gallery.appendChild(node);
            } else {
              // image
              const node = imgTpl.content.cloneNode(true);
              const imgEl = node.querySelector('img');
              const titleEl = node.querySelector('.title');
              const captionEl = node.querySelector('.caption');

              if (!imgEl) {
                console.warn('Image template missing <img> element for item:', it);
                continue;
              }

              imgEl.src = it.file || '';
              imgEl.alt = it.alt || it.title || '';

              if (titleEl) titleEl.textContent = it.title || '';
              if (captionEl) captionEl.textContent = it.caption || '';

              gallery.appendChild(node);
            }
          } catch (itemErr) {
            console.error('Error rendering media item:', itemErr, 'item:', it);
            // keep rendering remaining items
          }
        }
      } catch (err) {
        console.error(err);
        gallery.innerHTML = '<p class="error">Error loading gallery: ' + (err && err.message ? err.message : 'unknown error') + '</p>';
      }
    }
  </script>
</body>
</html>
